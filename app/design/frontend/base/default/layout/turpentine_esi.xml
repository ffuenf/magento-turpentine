<?xml version="1.0"?>
<!--
/**
 * Nexcess.net Turpentine Extension for Magento
 * Copyright (C) 2012  Nexcess.net L.L.C.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */
-->
<layout version="0.1.0">
    <!--
        The `customer_login` and `customer_logout` events are automatically
        added to the *flush_events* of all *private* ESI blocks, and should
        not be specified in the layout
    -->
    <default>
        <!--
            New block used to warn users who choose to navigate without Varnish while it's activated.
        -->
        <reference name="after_body_start">
            <block type="turpentine/notices" template="turpentine/notices.phtml" name="turpentine_notices" />
        </reference>
        <reference name="global_messages">
            <action method="setEsiOptions">
                <params>
                    <access>private</access>
                    <flush_events>
                        <core_session_abstract_add_message/>
                    </flush_events>
                    <only_cache_if>no_text</only_cache_if>
                </params>
            </action>
        </reference>
        <reference name="messages">
            <action method="setEsiOptions">
                <params>
                    <access>private</access>
                    <flush_events>
                        <core_session_abstract_add_message/>
                    </flush_events>
                    <only_cache_if>no_text</only_cache_if>
                </params>
            </action>
        </reference>
        <reference name="global_cookie_notice">
            <action method="setEsiOptions">
                <params>
                        <access>private</access>
                        <only_cache_if>no_text</only_cache_if>
                </params>
            </action>
        </reference>
        
    </default>
    <!-- Blocks only visible when logged in -->
    <customer_logged_in>
        <reference name="sale.reorder.sidebar">
            <action method="setEsiOptions">
                <params>
                    <access>private</access>
                    <flush_events>
                        <sales_quote_save_after/>
                        <checkout_onepage_controller_success_action/>
                    </flush_events>
                </params>
            </action>
        </reference>
    </customer_logged_in>

    <!-- We cache the checkout cart page on a per-client basis -->
    <checkout_cart_index>
        <turpentine_cache_flag value="0"/>
        </checkout_cart_index>

    <!-- We never cache anything in the checkout funnel -->
    <checkout_onepage_index>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_index>

    <checkout_onepage_progress>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_progress>

    <checkout_onepage_progress_billing>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_progress_billing>

    <checkout_onepage_progress_shipping>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_progress_shipping>

    <checkout_onepage_progress_shipping_method>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_progress_shipping_method>

    <checkout_onepage_progress_payment>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_progress_payment>

    <checkout_onepage_progress_review>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_progress_review>

    <checkout_onepage_paymentmethod>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_paymentmethod>

    <checkout_onepage_shippingmethod>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_shippingmethod>

    <checkout_onepage_additional>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_additional>

    <checkout_onepage_review>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_review>

    <checkout_onepage_success>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_success>

    <checkout_onepage_failure>
        <turpentine_cache_flag value="0"/>
    </checkout_onepage_failure>

    <checkout_prime_debug>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_debug>

    <checkout_prime_index>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_index>

    <checkout_prime_login_step_info>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_login_step_info>

    <checkout_prime_payment_step_info>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_payment_step_info>

    <checkout_prime_progress>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_progress>

    <checkout_prime_review>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_review>

    <checkout_prime_savepayment>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_savepayment>

    <checkout_prime_shipping_step_info>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_shipping_step_info>

    <checkout_prime_getstepinfo>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_getstepinfo>

    <checkout_prime_saveorder>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_saveorder>

    <checkout_prime_getaddress>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_getaddress>

    <checkout_prime_savemethod>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_savemethod>

    <checkout_prime_failure>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_failure>

    <checkout_prime_saveshippingmethod>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_saveshippingmethod>

    <checkout_prime_savecoupon>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_savecoupon>

    <checkout_prime_savebilling>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_savebilling>

    <checkout_prime_success>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_success>

    <checkout_prime_saveshipping>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_saveshipping>

    <checkout_prime_shippingmethod>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_shippingmethod>

    <checkout_prime_getadditional>
        <turpentine_cache_flag value="0"/>
    </checkout_prime_getadditional>

    <gomage_checkout_onepage_index>
        <turpentine_cache_flag value="0"/>
    </gomage_checkout_onepage_index>

    <gomage_checkout_onepage_methods>
        <turpentine_cache_flag value="0"/>
    </gomage_checkout_onepage_methods>

    <gomage_checkout_onepage_paymentmethod>
        <turpentine_cache_flag value="0"/>
    </gomage_checkout_onepage_paymentmethod>

    <gomage_checkout_onepage_centinel>
        <turpentine_cache_flag value="0"/>
    </gomage_checkout_onepage_centinel>

    <gomage_checkout_onepage_review>
        <turpentine_cache_flag value="0"/>
    </gomage_checkout_onepage_review>

    <gomage_checkout_onepage_customerlogin>
        <turpentine_cache_flag value="0"/>
    </gomage_checkout_onepage_customerlogin>

    <gomage_checkout_onepage_review>
        <turpentine_cache_flag value="0"/>
    </gomage_checkout_onepage_review>

    <gomage_checkout_onepage_forgotpassword>
        <turpentine_cache_flag value="0"/>
    </gomage_checkout_onepage_forgotpassword>

    <gomage_checkout_onepage_ajax>
        <turpentine_cache_flag value="0"/>
    </gomage_checkout_onepage_ajax>

    <gomage_checkout_onepage_save>
        <turpentine_cache_flag value="0"/>
    </gomage_checkout_onepage_save>

    <!-- End Checkout -->

    <!-- Customer Account -->

    <customer_account>
        <!--
        Disabling caching here disables it for all the customer account sub-
        pages, and it doesn't seem to be overridable. We'll do this for now
        and add the sub-pages at some later release.
        -->
        <turpentine_cache_flag value="0"/>
    </customer_account>

    <customer_account_login>
        <turpentine_cache_flag value="0"/>
    </customer_account_login>

    <customer_account_logoutsuccess>
        <turpentine_cache_flag value="0"/>
    </customer_account_logoutsuccess>

    <customer_account_create>
        <turpentine_cache_flag value="0"/>
    </customer_account_create>

    <customer_account_forgotpassword>
        <turpentine_cache_flag value="0"/>
    </customer_account_forgotpassword>

    <customer_account_resetpassword>
        <turpentine_cache_flag value="0"/>
    </customer_account_resetpassword>

    <customer_account_confirmation>
        <turpentine_cache_flag value="0"/>
    </customer_account_confirmation>
</layout>
